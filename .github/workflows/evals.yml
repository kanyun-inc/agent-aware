name: Evals

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  eval:
    name: Run Evaluations
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: read # è¯»å– workflow runs
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Run Evaluations
        id: eval
        env:
          # LLM Grader é…ç½® - AWS Bedrockï¼ˆæ¨èï¼‰
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-west-2
          CLAUDE_CODE_USE_BEDROCK: '1'
          LLM_MODEL: ${{ secrets.LLM_MODEL || 'anthropic.claude-3-5-sonnet-20241022-v2:0' }}
          # æˆ–ä½¿ç”¨ Anthropic ç›´æ¥ API
          # ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          # LLM_PROVIDER: anthropic
          # LLM_MODEL: claude-sonnet-4-20250514
        run: |
          pnpm eval --trials 5 --parallel 2>&1 | tee eval-output.txt
          exit_code=${PIPESTATUS[0]}
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Download main branch eval results
        if: github.event_name == 'pull_request'
        id: download-main
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // æŸ¥æ‰¾ main åˆ†æ”¯æœ€æ–°æˆåŠŸçš„ workflow run
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'evals.yml',
              branch: 'main',
              status: 'success',
              per_page: 1,
            });
            
            if (runs.data.workflow_runs.length === 0) {
              console.log('No successful main branch runs found');
              core.setOutput('found', 'false');
              return;
            }
            
            const runId = runs.data.workflow_runs[0].id;
            console.log(`Found main branch run: ${runId}`);
            
            // è·å– artifacts
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
            });
            
            const evalArtifact = artifacts.data.artifacts.find(a => a.name === 'eval-results');
            if (!evalArtifact) {
              console.log('No eval-results artifact found');
              core.setOutput('found', 'false');
              return;
            }
            
            // ä¸‹è½½ artifact
            const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: evalArtifact.id,
              archive_format: 'zip',
            });
            
            fs.writeFileSync('main-eval-results.zip', Buffer.from(download.data));
            core.setOutput('found', 'true');
            core.setOutput('run_id', runId);
        continue-on-error: true

      - name: Extract main branch results
        if: github.event_name == 'pull_request' && steps.download-main.outputs.found == 'true'
        run: |
          mkdir -p main-results
          unzip -o main-eval-results.zip -d main-results || true

      - name: Generate Summary
        env:
          MAIN_RESULTS_FOUND: ${{ steps.download-main.outputs.found }}
        run: |
          echo "## ğŸ“Š Agent-aware è¯„ä¼°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å¦‚æœæœ‰ main åˆ†æ”¯ç»“æœï¼Œæ˜¾ç¤ºå¯¹æ¯”
          if [ "$MAIN_RESULTS_FOUND" = "true" ]; then
            MAIN_JSON=$(ls -t main-results/*.json 2>/dev/null | head -1)
            CURRENT_JSON=$(ls -t evals/results/*.json 2>/dev/null | head -1)
            
            if [ -f "$MAIN_JSON" ] && [ -f "$CURRENT_JSON" ]; then
              echo "### ğŸ“Š å¯¹æ¯” main åˆ†æ”¯" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              MAIN_PASSED=$(jq '.summary.passedTasks' "$MAIN_JSON")
              MAIN_TOTAL=$(jq '.summary.totalTasks' "$MAIN_JSON")
              MAIN_TRIALS=$(jq '.trialsStats.totalTrials // 1' "$MAIN_JSON")
              CURRENT_PASSED=$(jq '.summary.passedTasks' "$CURRENT_JSON")
              CURRENT_TOTAL=$(jq '.summary.totalTasks' "$CURRENT_JSON")
              CURRENT_TRIALS=$(jq '.trialsStats.totalTrials // 1' "$CURRENT_JSON")
              
              MAIN_RATE=$((MAIN_PASSED * 100 / MAIN_TOTAL))
              CURRENT_RATE=$((CURRENT_PASSED * 100 / CURRENT_TOTAL))
              DIFF=$((CURRENT_RATE - MAIN_RATE))
              
              if [ $DIFF -gt 0 ]; then
                DIFF_STR="ğŸ“ˆ +${DIFF}%"
              elif [ $DIFF -lt 0 ]; then
                DIFF_STR="ğŸ“‰ ${DIFF}%"
              else
                DIFF_STR="â¡ï¸ Â±0%"
              fi
              
              echo "| æŒ‡æ ‡ | main | å½“å‰åˆ†æ”¯ | å˜åŒ– |" >> $GITHUB_STEP_SUMMARY
              echo "|------|------|----------|------|" >> $GITHUB_STEP_SUMMARY
              echo "| è¯„ä¼°æ¬¡æ•° | ${MAIN_TRIALS} æ¬¡ | ${CURRENT_TRIALS} æ¬¡ | |" >> $GITHUB_STEP_SUMMARY
              echo "| é€šè¿‡ç‡ | ${MAIN_RATE}% | ${CURRENT_RATE}% | ${DIFF_STR} |" >> $GITHUB_STEP_SUMMARY
              echo "| é€šè¿‡æ•° | ${MAIN_PASSED}/${MAIN_TOTAL} | ${CURRENT_PASSED}/${CURRENT_TOTAL} | |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # å½“å‰åˆ†æ”¯è¯¦ç»†æŠ¥å‘Š
          REPORT_FILE=$(ls -t evals/results/*.md 2>/dev/null | head -1)
          
          if [ -f "$REPORT_FILE" ]; then
            echo "### ğŸ“ å½“å‰åˆ†æ”¯è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat "$REPORT_FILE" | tail -n +2 >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ è¯„ä¼°æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥è¯„ä¼°æ—¥å¿—ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          MAIN_RESULTS_FOUND: ${{ steps.download-main.outputs.found }}
          MAIN_RUN_ID: ${{ steps.download-main.outputs.run_id }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // è§£æ JSON æŠ¥å‘Šè·å–ç»Ÿè®¡ä¿¡æ¯
            function parseReport(dir) {
              try {
                const files = fs.readdirSync(dir).filter(f => f.endsWith('.json')).sort().reverse();
                if (files.length === 0) return null;
                const content = fs.readFileSync(path.join(dir, files[0]), 'utf8');
                return JSON.parse(content);
              } catch (e) {
                return null;
              }
            }
            
            // è·å–å½“å‰åˆ†æ”¯æŠ¥å‘Š
            const currentReport = parseReport('evals/results');
            
            // è·å– main åˆ†æ”¯æŠ¥å‘Š
            const mainReport = process.env.MAIN_RESULTS_FOUND === 'true' 
              ? parseReport('main-results') 
              : null;
            
            // æ„å»ºè¯„è®ºå†…å®¹
            let body = '## ğŸ“Š Agent-aware è¯„ä¼°ç»“æœ\n\n';
            
            // å¯¹æ¯”è¡¨æ ¼
            if (currentReport && mainReport) {
              const current = currentReport.summary;
              const main = mainReport.summary;
              const currentRate = ((current.passedTasks / current.totalTasks) * 100).toFixed(0);
              const mainRate = ((main.passedTasks / main.totalTasks) * 100).toFixed(0);
              const diff = currentRate - mainRate;
              const diffStr = diff > 0 ? `+${diff}%` : diff < 0 ? `${diff}%` : 'Â±0%';
              const diffIcon = diff > 0 ? 'ğŸ“ˆ' : diff < 0 ? 'ğŸ“‰' : 'â¡ï¸';
              
              // è·å–è¯„ä¼°æ¬¡æ•°
              const mainTrials = mainReport.trialsStats?.totalTrials || 1;
              const currentTrials = currentReport.trialsStats?.totalTrials || 1;
              
              body += `### ğŸ“Š å¯¹æ¯” main åˆ†æ”¯\n\n`;
              body += `| æŒ‡æ ‡ | main | å½“å‰åˆ†æ”¯ | å˜åŒ– |\n`;
              body += `|------|------|----------|------|\n`;
              body += `| è¯„ä¼°æ¬¡æ•° | ${mainTrials} æ¬¡ | ${currentTrials} æ¬¡ | |\n`;
              body += `| é€šè¿‡ç‡ | ${mainRate}% | ${currentRate}% | ${diffIcon} ${diffStr} |\n`;
              body += `| é€šè¿‡æ•° | ${main.passedTasks}/${main.totalTasks} | ${current.passedTasks}/${current.totalTasks} | |\n\n`;
              
              // ä»»åŠ¡çº§åˆ«å¯¹æ¯”ï¼ˆåŒ…å«å¤šæ¬¡è¯„ä¼°ç»Ÿè®¡ï¼‰
              body += `<details>\n<summary>ğŸ“‹ ä»»åŠ¡è¯¦æƒ…å¯¹æ¯”</summary>\n\n`;
              body += `| ä»»åŠ¡ | main | å½“å‰ |\n`;
              body += `|------|------|------|\n`;
              
              const mainTasks = {};
              const mainTaskStats = mainReport.trialsStats?.taskStats || {};
              mainReport.results.forEach(r => { mainTasks[r.taskId] = r.passed; });
              
              const currentTaskStats = currentReport.trialsStats?.taskStats || {};
              
              currentReport.results.forEach(r => {
                // main åˆ†æ”¯çŠ¶æ€
                let mainStatus = '-';
                if (mainTasks[r.taskId] !== undefined) {
                  const mainStat = mainTaskStats[r.taskId];
                  if (mainStat && mainTrials > 1) {
                    mainStatus = `${mainStat.passCount}/${mainTrials} ${mainTasks[r.taskId] ? 'âœ…' : 'âŒ'}`;
                  } else {
                    mainStatus = mainTasks[r.taskId] ? 'âœ…' : 'âŒ';
                  }
                }
                
                // å½“å‰åˆ†æ”¯çŠ¶æ€
                let currentStatus;
                const currentStat = currentTaskStats[r.taskId];
                if (currentStat && currentTrials > 1) {
                  currentStatus = `${currentStat.passCount}/${currentTrials} ${r.passed ? 'âœ…' : 'âŒ'}`;
                } else {
                  currentStatus = r.passed ? 'âœ…' : 'âŒ';
                }
                
                body += `| ${r.taskId} | ${mainStatus} | ${currentStatus} |\n`;
              });
              body += `\n</details>\n\n`;
            } else if (currentReport) {
              body += `> â„¹ï¸ main åˆ†æ”¯æš‚æ— è¯„ä¼°åŸºå‡†æ•°æ®\n\n`;
            }
            
            // å½“å‰åˆ†æ”¯è¯¦ç»†æŠ¥å‘Š
            body += `### ğŸ“ å½“å‰åˆ†æ”¯è¯„ä¼°æŠ¥å‘Š\n\n`;
            
            if (currentReport) {
              const { summary } = currentReport;
              body += `- **é€šè¿‡ç‡**: ${((summary.passedTasks / summary.totalTasks) * 100).toFixed(0)}%\n`;
              body += `- **é€šè¿‡æ•°**: ${summary.passedTasks}/${summary.totalTasks}\n\n`;
              
              body += `| ä»»åŠ¡ | è€—æ—¶ | çŠ¶æ€ |\n`;
              body += `|------|------|------|\n`;
              currentReport.results.forEach(r => {
                const status = r.passed ? 'âœ…' : 'âŒ';
                const duration = (r.duration / 1000).toFixed(1);
                body += `| ${r.taskId} | ${duration}s | ${status} |\n`;
              });
            } else {
              body += 'âš ï¸ è¯„ä¼°æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ Actions æ—¥å¿—ã€‚\n';
            }
            
            body += '\n\n---\n';
            body += `*Generated by [Agent-aware Evals](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})*`;
            
            // æŸ¥æ‰¾å¹¶æ›´æ–°æˆ–åˆ›å»ºè¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('Agent-aware è¯„ä¼°ç»“æœ')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }

      - name: Upload Eval Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: eval-results
          path: |
            evals/results/*.json
            evals/results/*.md
            evals/results/transcripts/
          retention-days: 30

      - name: Check Eval Status
        if: steps.eval.outputs.exit_code != '0'
        run: |
          echo "::error::è¯„ä¼°æœªå…¨éƒ¨é€šè¿‡ï¼Œè¯·æ£€æŸ¥æŠ¥å‘Šè¯¦æƒ…"
          exit 1
